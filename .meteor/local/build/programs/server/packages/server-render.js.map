{"version":3,"sources":["meteor://ðŸ’»app/packages/server-render/server.js","meteor://ðŸ’»app/packages/server-render/server-register.js","meteor://ðŸ’»app/packages/server-render/server-sink.js"],"names":["module","export","onPageLoad","Meteor","watch","require","v","startupPromise","Promise","startup","pageLoadCallbacks","Set","callback","add","remove","delete","clear","chain","handler","then","promise","resolve","forEach","WebAppInternals","MagicString","default","SAXParser","createStream","create","ServerSink","isReadable","registerBoilerplateDataCallback","request","data","arch","sink","maybeMadeChanges","reallyMadeChanges","rewrite","property","html","magic","parser","locationInfo","Object","keys","htmlById","length","stream","lastStart","start","on","name","attrs","selfClosing","loc","some","attr","value","slice","endOffset","append","Buffer","from","location","end","write","bind","head","dynamicHead","body","dynamicBody","statusCode","responseHeaders","headers","constructor","appendToHead","appendContent","appendToBody","appendToElementById","id","renderIntoElementById","redirect","code","Location","setStatusCode","setHeader","key","getHeaders","getCookies","cookies","pipe","readable","_read","_readableState","object","content","madeChanges","Array","isArray","elem","toString"],"mappings":"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","file":"/packages/server-render.js","sourcesContent":["import { Meteor } from \"meteor/meteor\";\nimport \"./server-register.js\";\n\nconst startupPromise = new Promise(Meteor.startup);\nconst pageLoadCallbacks = new Set;\n\nexport function onPageLoad(callback) {\n  if (typeof callback === \"function\") {\n    pageLoadCallbacks.add(callback);\n  }\n\n  // Return the callback so that it can be more easily removed later.\n  return callback;\n}\n\nonPageLoad.remove = function (callback) {\n  pageLoadCallbacks.delete(callback);\n};\n\nonPageLoad.clear = function () {\n  pageLoadCallbacks.clear();\n};\n\nonPageLoad.chain = function (handler) {\n  return startupPromise.then(() => {\n    let promise = Promise.resolve();\n    pageLoadCallbacks.forEach(callback => {\n      promise = promise.then(() => handler(callback));\n    });\n    return promise;\n  });\n};\n","import { WebAppInternals } from \"meteor/webapp\";\nimport MagicString from \"magic-string\";\nimport { SAXParser } from \"parse5\";\nimport { create as createStream } from \"combined-stream2\";\nimport { ServerSink, isReadable } from \"./server-sink.js\";\nimport { onPageLoad } from \"./server.js\";\n\nWebAppInternals.registerBoilerplateDataCallback(\n  \"meteor/server-render\",\n  (request, data, arch) => {\n    const sink = new ServerSink(request, arch);\n\n    return onPageLoad.chain(\n      callback => callback(sink, request)\n    ).then(() => {\n      if (! sink.maybeMadeChanges) {\n        return false;\n      }\n\n      let reallyMadeChanges = false;\n\n      function rewrite(property) {\n        const html = data[property];\n        if (typeof html !== \"string\") {\n          return;\n        }\n\n        const magic = new MagicString(html);\n        const parser = new SAXParser({\n          locationInfo: true\n        });\n\n        data[property] = parser;\n\n        if (Object.keys(sink.htmlById).length) {\n          const stream = createStream();\n\n          let lastStart = magic.start;\n          parser.on(\"startTag\", (name, attrs, selfClosing, loc) => {\n            attrs.some(attr => {\n              if (attr.name === \"id\") {\n                let html = sink.htmlById[attr.value];\n                if (html) {\n                  reallyMadeChanges = true;\n                  const start = magic.slice(lastStart, loc.endOffset);\n                  stream.append(Buffer.from(start, \"utf8\"));\n                  stream.append(\n                    typeof html === \"string\"\n                      ? Buffer.from(html, \"utf8\")\n                      : html\n                  );\n                  lastStart = loc.endOffset;\n                }\n                return true;\n              }\n            });\n          });\n\n          parser.on(\"endTag\", (name, location) => {\n            if (location.endOffset === html.length) {\n              // reached the end of the template\n              const end = magic.slice(lastStart);\n              stream.append(Buffer.from(end, \"utf8\"));\n            }\n          })\n\n          data[property] = stream;\n        }\n\n        parser.write(html, parser.end.bind(parser));\n      }\n\n      if (sink.head) {\n        data.dynamicHead = (data.dynamicHead || \"\") + sink.head;\n        reallyMadeChanges = true;\n      }\n\n      if (Object.keys(sink.htmlById).length > 0) {\n        // We don't currently allow injecting HTML into the <head> except\n        // by calling sink.appendHead(html).\n        rewrite(\"body\");\n        rewrite(\"dynamicBody\");\n      }\n\n      if (sink.body) {\n        data.dynamicBody = (data.dynamicBody || \"\") + sink.body;\n        reallyMadeChanges = true;\n      }\n\n      if (sink.statusCode) {\n        data.statusCode = sink.statusCode;\n        reallyMadeChanges = true;\n      }\n\n      if (Object.keys(sink.responseHeaders)){\n        data.headers = sink.responseHeaders;\n        reallyMadeChanges = true;\n      }\n\n      return reallyMadeChanges;\n    });\n  }\n);\n","export class ServerSink {\n  constructor(request, arch) {\n    this.request = request;\n    this.arch = arch;\n    this.head = \"\";\n    this.body = \"\";\n    this.htmlById = Object.create(null);\n    this.maybeMadeChanges = false;\n    this.statusCode = null;\n    this.responseHeaders = {};\n  }\n\n  appendToHead(html) {\n    if (appendContent(this, \"head\", html)) {\n      this.maybeMadeChanges = true;\n    }\n  }\n\n  appendToBody(html) {\n    if (appendContent(this, \"body\", html)) {\n      this.maybeMadeChanges = true;\n    }\n  }\n\n  appendToElementById(id, html) {\n    if (appendContent(this.htmlById, id, html)) {\n      this.maybeMadeChanges = true;\n    }\n  }\n\n  renderIntoElementById(id, html) {\n    this.htmlById[id] = \"\";\n    this.appendToElementById(id, html);\n  }\n\n  redirect(location, code = 301) {\n    this.maybeMadeChanges = true;\n    this.statusCode = code;\n    this.responseHeaders.Location = location;\n  }\n\n  // server only methods\n  setStatusCode(code) {\n    this.maybeMadeChanges = true;\n    this.statusCode = code;\n  }\n\n  setHeader(key, value) {\n    this.maybeMadeChanges = true;\n    this.responseHeaders[key] = value;\n  }\n\n  getHeaders() {\n    return this.request.headers;\n  }\n\n  getCookies() {\n    return this.request.cookies;\n  }\n}\n\nexport function isReadable(stream) {\n  return (\n    stream !== null &&\n    typeof stream === 'object' &&\n    typeof stream.pipe === 'function' &&\n    stream.readable !== false &&\n    typeof stream._read === 'function' &&\n    typeof stream._readableState === 'object'\n  );\n}\n\nfunction appendContent(object, property, content) {\n  let madeChanges = false;\n\n  if (Array.isArray(content)) {\n    content.forEach(elem => {\n      if (appendContent(object, property, elem)) {\n        madeChanges = true;\n      }\n    });\n  } else if (isReadable(content)) {\n    object[property] = content;\n    madeChanges = true;\n  } else if ((content = content && content.toString(\"utf8\"))) {\n    object[property] = (object[property] || \"\") + content;\n    madeChanges = true;\n  } \n  return madeChanges;\n}\n"]}