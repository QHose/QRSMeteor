{"metadata":{},"options":{"plugins":[{"key":"base$1$0","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"base$1$1","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"base$0$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$2","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"base$0$3","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"polyfill":false,"useBuiltIns":true}},{"key":"base$0$4","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$5","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"base$0$8","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"base$0$9","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"base$0$10","visitor":{"_exploded":{},"_verified":{},"PrivateName":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}}],"compact":false,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"server/main.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining","pipelineOperator","throwExpressions","jsx",["flow",{}],["flow",{}],"objectRestSpread","objectRestSpread","dynamicImport","asyncGenerators","classProperties","classPrivateProperties"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"sourceFileName":"server/main.js","filename":"server/main.js","sourceMaps":true,"passPerPreset":false,"envName":"development","cwd":"/home/martijn/Documents/GitHub/QRSMeteor","root":"/home/martijn/Documents/GitHub/QRSMeteor","presets":[],"generatorOpts":{"filename":"server/main.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/main.js"}},"code":"let Meteor;\nmodule.watch(require(\"meteor/meteor\"), {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet http;\nmodule.watch(require(\"meteor/meteor\"), {\n  http(v) {\n    http = v;\n  }\n\n}, 1);\nlet Apps, TemplateApps, GeneratedResources;\nmodule.watch(require(\"/imports/api/apps\"), {\n  Apps(v) {\n    Apps = v;\n  },\n\n  TemplateApps(v) {\n    TemplateApps = v;\n  },\n\n  GeneratedResources(v) {\n    GeneratedResources = v;\n  }\n\n}, 2);\nlet APILogs, REST_Log;\nmodule.watch(require(\"/imports/api/APILogs\"), {\n  APILogs(v) {\n    APILogs = v;\n  },\n\n  REST_Log(v) {\n    REST_Log = v;\n  }\n\n}, 3);\nlet WebApp;\nmodule.watch(require(\"meteor/webapp\"), {\n  WebApp(v) {\n    WebApp = v;\n  }\n\n}, 4);\nlet Streams;\nmodule.watch(require(\"/imports/api/streams\"), {\n  Streams(v) {\n    Streams = v;\n  }\n\n}, 5);\nlet Customers;\nmodule.watch(require(\"/imports/api/customers\"), {\n  Customers(v) {\n    Customers = v;\n  }\n\n}, 6);\nlet QSApp;\nmodule.watch(require(\"/imports/api/server/QRSFunctionsApp\"), {\n  \"*\"(v) {\n    QSApp = v;\n  }\n\n}, 7);\nlet QSStream;\nmodule.watch(require(\"/imports/api/server/QRSFunctionsStream\"), {\n  \"*\"(v) {\n    QSStream = v;\n  }\n\n}, 8);\nlet QSLic;\nmodule.watch(require(\"/imports/api/server/QRSFunctionsLicense\"), {\n  \"*\"(v) {\n    QSLic = v;\n  }\n\n}, 9);\nlet QSProxy;\nmodule.watch(require(\"/imports/api/server/QPSFunctions\"), {\n  \"*\"(v) {\n    QSProxy = v;\n  }\n\n}, 10);\nlet QSSystem;\nmodule.watch(require(\"/imports/api/server/QRSFunctionsSystemRules\"), {\n  \"*\"(v) {\n    QSSystem = v;\n  }\n\n}, 11);\nlet QSExtensions;\nmodule.watch(require(\"/imports/api/server/QRSFunctionsExtension\"), {\n  \"*\"(v) {\n    QSExtensions = v;\n  }\n\n}, 12);\nlet QSCustomProps;\nmodule.watch(require(\"/imports/api/server/QRSFunctionsCustomProperties\"), {\n  \"*\"(v) {\n    QSCustomProps = v;\n  }\n\n}, 13);\nlet senseConfig, authHeaders;\nmodule.watch(require(\"/imports/api/config\"), {\n  senseConfig(v) {\n    senseConfig = v;\n  },\n\n  authHeaders(v) {\n    authHeaders = v;\n  }\n\n}, 14);\nmodule.watch(require(\"/imports/startup/accounts-config.js\"));\nlet shell;\nmodule.watch(require(\"node-powershell\"), {\n  default(v) {\n    shell = v;\n  }\n\n}, 15);\n\nvar os = require('os'); //stop on unhandled errors\n\n\nprocess.on(\"unhandledRejection\", up => {\n  throw up;\n}); //import config for Qlik Sense QRS and Engine API.\n\nconst path = require(\"path\");\n\nvar fs = require(\"fs-extra\");\n\nvar connectHandler = WebApp.connectHandlers; // get meteor-core's connect-implementation\n// attach connect-style middleware for response header injection\n\nMeteor.startup(function () {\n  WebApp.addHtmlAttributeHook(() => ({\n    lang: 'en'\n  }));\n  connectHandler.use(function (req, res, next) {\n    res.setHeader('access-control-allow-origin', '*');\n    return next();\n  });\n});\nMeteor.startup(function () {\n  return Promise.asyncApply(() => {\n    // process.env.ROOT_URL = \"http://\" + Meteor.settings.public.qlikSenseHost;\n    // console.log(\n    //     \"********* We expect Qlik Sense to run on host: \",\n    //     process.env.ROOT_URL + \":\" + Meteor.settings.public.qlikSensePort\n    // );\n    // console.log('********* For END USERS we expect Sense to run on host: ', Meteor.settings.public.qlikSenseHost + ':' + Meteor.settings.public.qlikSensePort);\n    Promise.await(initQlikSense());\n    removeGeneratedResources();\n    optimizeMongoDB();\n  });\n}); //\n// ─── SETUP QLIK SENSE AFTER A CLEAN QlIK SENSE INSTALL ─────────────────────────────────────\n//\n//Check if Qlik Sense has been properly setup for this MeteorQRS tool..\n\nfunction initQlikSense() {\n  return Promise.asyncApply(() => {\n    console.log(\"------------------------------------\");\n    console.log(\"INIT QLIK SENSE\");\n    console.log(\"Project root folder: \", Meteor.absolutePath);\n\n    if (!Meteor.settings.broker.automationBaseFolder) {\n      Meteor.settings.broker.automationBaseFolder = path.join(Meteor.absolutePath, \".automation\");\n      console.log(\"Meteor.settings.broker.automationBaseFolder was empty, setting it to default: \", Meteor.settings.broker.automationBaseFolder);\n    }\n\n    if (!Meteor.settings.broker.customerDataDir) {\n      Meteor.settings.broker.customerDataDir = path.join(Meteor.absolutePath, \"customerData\");\n      console.log(\"Meteor.settings.broker.customerDataDir was empty, setting it to default: \", Meteor.settings.broker.customerDataDir);\n    }\n\n    try {\n      if (Meteor.settings.broker.runInitialQlikSenseSetup) {\n        console.log(\"The runInitialQlikSenseSetup setting has been set to true, so we expect to have a fresh Qlik Sense installation for which we now automatically populate with the apps, streams, license, security rules etc.\");\n\n        if (Meteor.settings.broker.qlikSense.installQlikSense) {\n          Promise.await(installQlikSense()); // await timeout(1000 * 60 * 20); //wait 20 minutes till the Qlik Sense installation has completed...\n        }\n\n        QSLic.insertLicense();\n        QSLic.insertUserAccessRule();\n        QSSystem.disableDefaultSecurityRules();\n        Promise.await(QSProxy.createVirtualProxies());\n        Promise.await(timeout(4000)); //wait till the proxy has restarted...\n\n        Promise.await(QSSystem.createSecurityRules());\n        QSStream.initSenseStreams();\n        Promise.await(QSApp.uploadAndPublishTemplateApps());\n        QSApp.setAppIDs();\n        Promise.await(QSApp.createAppConnections()); //import extra connections\n\n        QSExtensions.uploadExtensions();\n        QSLic.saveSystemRules();\n      } else {\n        //set the app Id for the self service bi and the slide generator app, for use in the IFrames etc.\n        QSApp.setAppIDs();\n      } //now qlik sense has been installed, we can try to connect, and load the streams and apps into our mongoDB\n\n\n      Meteor.call(\"updateLocalSenseCopy\");\n    } catch (error) {\n      console.error(\"Main.js, initQlikSense: Failed to run the initialization of Qlik Sense. Most likely reason is that Qlik Sense has not been installed, wrong hostnames, wrong cert directory...\", error);\n    }\n  });\n} //helper functions to await a set timeout\n\n\nfunction timeout(ms) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\nfunction sleep(fn, ...args) {\n  return Promise.asyncApply(() => {\n    Promise.await(timeout(3000));\n    return fn(...args);\n  });\n} //\n// ─── INSTALL QLIK SENSE ───────────────────────────────────────────────────────────\n//\n\n\nvar installQlikSense = function () {\n  return Promise.asyncApply(() => {\n    console.log(\"installQlikSense is true in the settings file so start creating the config file for the Sense silent script...\"); //we dynamically populate the Qlik sense silent installation config file, the hostname is the variable... Because we create a folder share with this name\n\n    var configFile = `<?xml version=\"1.0\"?>\n    <SharedPersistenceConfiguration xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\">\n    <DbUserName>username</DbUserName>\n    <DbUserPassword>password</DbUserPassword>\n    <DbHost>` + os.hostname() + `</DbHost>\n    <DbPort>4432</DbPort>\n    <RootDir>\\\\\\\\` + os.hostname() + `\\\\QlikSenseShare</RootDir>\n    <StaticContentRootDir>\\\\\\\\` + os.hostname() + `\\\\QlikSenseShare\\\\StaticContent</StaticContentRootDir>\n    <CustomDataRootDir>\\\\\\\\` + os.hostname() + `\\\\QlikSenseShare\\\\CustomData</CustomDataRootDir>\n    <ArchivedLogsDir>\\\\\\\\` + os.hostname() + `\\\\QlikSenseShare\\\\ArchivedLogs</ArchivedLogsDir>\n    <AppsDir>\\\\\\\\` + os.hostname() + `\\\\QlikSenseShare\\\\Apps</AppsDir>\n    <CreateCluster>true</CreateCluster>\n    <InstallLocalDb>true</InstallLocalDb>\n    <ConfigureDbListener>false</ConfigureDbListener>\n    <ListenAddresses>*</ListenAddresses>\n    <IpRange>0.0.0.0/0</IpRange>\n    </SharedPersistenceConfiguration>`; //SAVE Silent install CONFIG TO THE EXPORT FOLDER\n\n    var file = path.join(Meteor.settings.broker.automationBaseFolder, \"InstallationSoftware\", \"spc.cfg\");\n    fs.outputFile(file, configFile, \"utf-8\");\n    console.log(\"------------------------------------\");\n    console.log('config file created! you can now run the \"start.bat\" in the \"C:\\\\GitHub\\QRSMeteor\\\\.automation\\\\InstallationSoftware\" folder as administrator');\n    console.error(\"We now create an error to ensure QRSMeteor stops further setup.  To test the Sense installation, you can open the QMC (also check the hostname). The QMC will ask for you license. But do not do anything like inserting the license. QRSMeteor will do this for you.\");\n    console.log(\"------------------------------------\");\n    throw new Error(\"Dummy error to make sure QRSMeteor stops running...\"); //removed auto install of sense, to prevent an issue with the rights...\n    // var executable = 'startSilentInstall.ps1';\n    // var installer = path.join(Meteor.settings.broker.automationBaseFolder, 'InstallationSoftware', executable);\n    // console.log('installer', installer)\n    // await new Promise(function(resolve, reject) {\n    //     try {\n    //         var spawn = require(\"child_process\").spawn,\n    //             child;\n    //         child = spawn(\"powershell.exe\", [installer]);\n    //         child.stdout.on(\"data\", function(data) {\n    //             console.log(\"Powershell Data: \" + data);\n    //         });\n    //         child.stderr.on(\"data\", function(data) {\n    //             console.error(\"Powershell Errors: \" + data);\n    //             return reject('Error in running the silent installation script of qlik sense...');\n    //         });\n    //         child.on(\"exit\", function() {\n    //             console.log(\"Powershell Script finished\");\n    //             return resolve(\"Powershell Script finished\");\n    //         });\n    //         child.stdin.end(); //end input.\n    //     } catch (error) {\n    //         console.error('error in calling the start of silent install of qlik sense, ', error);\n    //     }\n    // });\n  });\n}; // let ps = new shell({\n//     executionPolicy: 'Bypass',\n//     noProfile: true\n// });\n// var folder = Meteor.settings.broker.qlikSense.sharedPersistanceFolder;\n// var name = Meteor.settings.broker.qlikSense.sharedPersistanceFolderName;\n// // ps.addCommand('Write-Host Creating a shared folder on: ' + folder);\n// ps.addCommand('New-Item \"C:\\\\test\" –type directory');\n// // ps.addCommand('New-SmbShare –Name ' + name + ' –Path ' + folder + ' –FullAccess Everyone  ')\n// ps.invoke()\n//     .then(output => {\n//         console.log(output);\n//     })\n//     .catch(err => {\n//         console.error('Installation of Qlik Sense failed, make sure you check the log file in GitHub\\QRSMeteor\\.automation\\InstallationSoftware\\log.txt', err)\n//         ps.dispose();\n//     });\n//\n// ─── REMOVE STREAMS AND APPS CREATED DURING THE SAAS DEMO ───────────────────────\n//\n\n\nfunction removeGeneratedResources() {\n  // console.log('remove the all generated resources on each server start');\n  // Meteor.setTimeout(function() {\n  //     console.log('remove all generated resources in mongo and qlik sense periodically by making use of a server side timer');\n  //     Meteor.call('removeGeneratedResources', {});\n  // }, 0); //remove all logs directly at startup\n  if (Meteor.settings.broker.automaticCleanUpGeneratedApps === \"Yes\") {\n    Meteor.setInterval(function () {\n      console.log(\"remove all generated resources in mongo and qlik sense periodically by making use of a server side timer\");\n      Meteor.call(\"removeGeneratedResources\", {});\n    }, 1 * 86400000); //remove all logs/apps/streams every 1 day\n  }\n}\n\nfunction optimizeMongoDB() {\n  // console.log('## setting up mongo indexes on generationUserId in the generated resources, customers and other collections, to increase mongo performance');\n  TemplateApps._ensureIndex({\n    generationUserId: 1,\n    id: 1\n  });\n\n  GeneratedResources._ensureIndex({\n    generationUserId: 1,\n    id: 1\n  });\n\n  Apps._ensureIndex({\n    id: 1\n  });\n\n  Customers._ensureIndex({\n    generationUserId: 1\n  });\n\n  Streams._ensureIndex({\n    id: 1\n  });\n\n  APILogs._ensureIndex({\n    createdBy: 1\n  });\n\n  APILogs._ensureIndex({\n    createDate: 1\n  });\n} //\n// ─── GET AN UPDATE WHEN QLIK SENSE HAS CHANGED ──────────────────────────────────\n//\n// function createNotificationListeners() {\n//     //Create notification listener in Qlik sense https://help.qlik.com/en-US/sense-developer/3.1/Subsystems/RepositoryServiceAPI/Content/RepositoryServiceAPI/RepositoryServiceAPI-Notification-Remove-Change-Subscription.htm\n//     //console.log('********* On meteor startup, Meteor tool registers itself at Qlik Sense to get notifications from Sense on changes to apps and streams.');\n//     //console.log('********* we try to register a notification on this URL: HTTP post to http://' + senseConfig.SenseServerInternalLanIP + ':' + senseConfig.port + '/' + senseConfig.virtualProxy + '/qrs/notification?name=app');\n//     //console.log('********* The notification URL for Streams is: ' + Meteor.settings.private.notificationURL + '/streams');\n//     try {\n//         const resultApp = HTTP.post('http://' + senseConfig.SenseServerInternalLanIP + ':' + senseConfig.port + '/' + senseConfig.virtualProxy + '/qrs/notification?name=app', {\n//             headers: authHeaders,\n//             params: { 'xrfkey': senseConfig.xrfkey },\n//             data: Meteor.settings.private.notificationURL + '/apps'\n//         })\n//         const resultStream = HTTP.post('http://' + senseConfig.SenseServerInternalLanIP + ':' + senseConfig.port + '/' + senseConfig.virtualProxy + '/qrs/notification?name=stream', {\n//                 headers: authHeaders,\n//                 params: { 'xrfkey': senseConfig.xrfkey },\n//                 data: Meteor.settings.private.notificationURL + '/streams'\n//             })\n//             //console.log('Register notication success');\n//             // //console.log('the result from sense register App notification was: ', resultApp);\n//             // //console.log('the result from sense register Stream notification was: ', resultStream);\n//     } catch (err) {\n//         console.error('Create notification subscription in sense qrs failed', err);\n//         // throw new Meteor.Error('Create notification subscription in sense qrs failed', err);\n//     }\n// }","map":{"version":3,"sources":["server/main.js"],"names":["Meteor","module","watch","require","v","http","Apps","TemplateApps","GeneratedResources","APILogs","REST_Log","WebApp","Streams","Customers","QSApp","QSStream","QSLic","QSProxy","QSSystem","QSExtensions","QSCustomProps","senseConfig","authHeaders","shell","default","os","process","on","up","path","fs","connectHandler","connectHandlers","startup","addHtmlAttributeHook","lang","use","req","res","next","setHeader","initQlikSense","removeGeneratedResources","optimizeMongoDB","console","log","absolutePath","settings","broker","automationBaseFolder","join","customerDataDir","runInitialQlikSenseSetup","qlikSense","installQlikSense","insertLicense","insertUserAccessRule","disableDefaultSecurityRules","createVirtualProxies","timeout","createSecurityRules","initSenseStreams","uploadAndPublishTemplateApps","setAppIDs","createAppConnections","uploadExtensions","saveSystemRules","call","error","ms","Promise","resolve","setTimeout","sleep","fn","args","configFile","hostname","file","outputFile","Error","automaticCleanUpGeneratedApps","setInterval","_ensureIndex","generationUserId","id","createdBy","createDate"],"mappings":"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","sourcesContent":["import { Meteor } from \"meteor/meteor\";\nimport { http } from \"meteor/meteor\";\nimport { Apps, TemplateApps, GeneratedResources } from \"/imports/api/apps\";\nimport { APILogs, REST_Log } from \"/imports/api/APILogs\";\nimport { WebApp } from 'meteor/webapp';\n\n//import meteor collections\nimport { Streams } from \"/imports/api/streams\";\nimport { Customers } from \"/imports/api/customers\";\n\nimport * as QSApp from \"/imports/api/server/QRSFunctionsApp\";\nimport * as QSStream from \"/imports/api/server/QRSFunctionsStream\";\nimport * as QSLic from \"/imports/api/server/QRSFunctionsLicense\";\nimport * as QSProxy from \"/imports/api/server/QPSFunctions\";\nimport * as QSSystem from \"/imports/api/server/QRSFunctionsSystemRules\";\nimport * as QSExtensions from \"/imports/api/server/QRSFunctionsExtension\";\nimport * as QSCustomProps from \"/imports/api/server/QRSFunctionsCustomProperties\";\nvar os = require('os')\n\n//stop on unhandled errors\nprocess.on(\"unhandledRejection\", up => {\n    throw up;\n});\n\n//import config for Qlik Sense QRS and Engine API.\nimport { senseConfig, authHeaders } from \"/imports/api/config\";\nimport \"/imports/startup/accounts-config.js\";\nconst path = require(\"path\");\nvar fs = require(\"fs-extra\");\nimport shell from \"node-powershell\";\n\nvar connectHandler = WebApp.connectHandlers; // get meteor-core's connect-implementation\n\n// attach connect-style middleware for response header injection\nMeteor.startup(function() {\n    WebApp.addHtmlAttributeHook(() => ({ lang: 'en' }));\n    connectHandler.use(function(req, res, next) {\n        res.setHeader('access-control-allow-origin', '*');\n        return next();\n    })\n})\n\n\nMeteor.startup(async function() {\n    // process.env.ROOT_URL = \"http://\" + Meteor.settings.public.qlikSenseHost;\n    // console.log(\n    //     \"********* We expect Qlik Sense to run on host: \",\n    //     process.env.ROOT_URL + \":\" + Meteor.settings.public.qlikSensePort\n    // );\n    // console.log('********* For END USERS we expect Sense to run on host: ', Meteor.settings.public.qlikSenseHost + ':' + Meteor.settings.public.qlikSensePort);\n    await initQlikSense();\n    removeGeneratedResources();\n    optimizeMongoDB();\n});\n\n//\n// ─── SETUP QLIK SENSE AFTER A CLEAN QlIK SENSE INSTALL ─────────────────────────────────────\n//\n\n//Check if Qlik Sense has been properly setup for this MeteorQRS tool..\nasync function initQlikSense() {\n    console.log(\"------------------------------------\");\n    console.log(\"INIT QLIK SENSE\");\n    console.log(\"Project root folder: \", Meteor.absolutePath);\n    if (!Meteor.settings.broker.automationBaseFolder) {\n        Meteor.settings.broker.automationBaseFolder = path.join(\n            Meteor.absolutePath,\n            \".automation\"\n        );\n        console.log(\n            \"Meteor.settings.broker.automationBaseFolder was empty, setting it to default: \",\n            Meteor.settings.broker.automationBaseFolder\n        );\n    }\n    if (!Meteor.settings.broker.customerDataDir) {\n        Meteor.settings.broker.customerDataDir = path.join(\n            Meteor.absolutePath,\n            \"customerData\"\n        );\n        console.log(\n            \"Meteor.settings.broker.customerDataDir was empty, setting it to default: \",\n            Meteor.settings.broker.customerDataDir\n        );\n    }\n\n    try {\n        if (Meteor.settings.broker.runInitialQlikSenseSetup) {\n            console.log(\n                \"The runInitialQlikSenseSetup setting has been set to true, so we expect to have a fresh Qlik Sense installation for which we now automatically populate with the apps, streams, license, security rules etc.\"\n            );\n            if (Meteor.settings.broker.qlikSense.installQlikSense) {\n                await installQlikSense();\n                // await timeout(1000 * 60 * 20); //wait 20 minutes till the Qlik Sense installation has completed...\n            }\n            QSLic.insertLicense();\n            QSLic.insertUserAccessRule();\n            QSSystem.disableDefaultSecurityRules();\n            await QSProxy.createVirtualProxies();\n            await timeout(4000); //wait till the proxy has restarted...\n            await QSSystem.createSecurityRules();\n            QSStream.initSenseStreams();\n            await QSApp.uploadAndPublishTemplateApps();\n            QSApp.setAppIDs();\n            await QSApp.createAppConnections(); //import extra connections\n            QSExtensions.uploadExtensions();\n            QSLic.saveSystemRules();\n        } else {\n            //set the app Id for the self service bi and the slide generator app, for use in the IFrames etc.\n            QSApp.setAppIDs();\n        }\n\n        //now qlik sense has been installed, we can try to connect, and load the streams and apps into our mongoDB\n        Meteor.call(\"updateLocalSenseCopy\");\n    } catch (error) {\n        console.error(\n            \"Main.js, initQlikSense: Failed to run the initialization of Qlik Sense. Most likely reason is that Qlik Sense has not been installed, wrong hostnames, wrong cert directory...\",\n            error\n        );\n    }\n}\n\n//helper functions to await a set timeout\nfunction timeout(ms) {\n    return new Promise(resolve => setTimeout(resolve, ms));\n}\nasync function sleep(fn, ...args) {\n    await timeout(3000);\n    return fn(...args);\n}\n\n//\n// ─── INSTALL QLIK SENSE ───────────────────────────────────────────────────────────\n//\n\nvar installQlikSense = async function() {\n    console.log(\n        \"installQlikSense is true in the settings file so start creating the config file for the Sense silent script...\"\n    );\n\n    //we dynamically populate the Qlik sense silent installation config file, the hostname is the variable... Because we create a folder share with this name\n    var configFile =\n        `<?xml version=\"1.0\"?>\n    <SharedPersistenceConfiguration xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\">\n    <DbUserName>username</DbUserName>\n    <DbUserPassword>password</DbUserPassword>\n    <DbHost>` +\n        os.hostname() +\n        `</DbHost>\n    <DbPort>4432</DbPort>\n    <RootDir>\\\\\\\\` +\n        os.hostname() +\n        `\\\\QlikSenseShare</RootDir>\n    <StaticContentRootDir>\\\\\\\\` +\n        os.hostname() +\n        `\\\\QlikSenseShare\\\\StaticContent</StaticContentRootDir>\n    <CustomDataRootDir>\\\\\\\\` +\n        os.hostname() +\n        `\\\\QlikSenseShare\\\\CustomData</CustomDataRootDir>\n    <ArchivedLogsDir>\\\\\\\\` +\n        os.hostname() +\n        `\\\\QlikSenseShare\\\\ArchivedLogs</ArchivedLogsDir>\n    <AppsDir>\\\\\\\\` +\n        os.hostname() +\n        `\\\\QlikSenseShare\\\\Apps</AppsDir>\n    <CreateCluster>true</CreateCluster>\n    <InstallLocalDb>true</InstallLocalDb>\n    <ConfigureDbListener>false</ConfigureDbListener>\n    <ListenAddresses>*</ListenAddresses>\n    <IpRange>0.0.0.0/0</IpRange>\n    </SharedPersistenceConfiguration>`;\n    //SAVE Silent install CONFIG TO THE EXPORT FOLDER\n    var file = path.join(\n        Meteor.settings.broker.automationBaseFolder,\n        \"InstallationSoftware\",\n        \"spc.cfg\"\n    );\n    fs.outputFile(file, configFile, \"utf-8\");\n\n    console.log(\"------------------------------------\");\n    console.log(\n        'config file created! you can now run the \"start.bat\" in the \"C:\\\\GitHub\\QRSMeteor\\\\.automation\\\\InstallationSoftware\" folder as administrator'\n    );\n    console.error(\n        \"We now create an error to ensure QRSMeteor stops further setup.  To test the Sense installation, you can open the QMC (also check the hostname). The QMC will ask for you license. But do not do anything like inserting the license. QRSMeteor will do this for you.\"\n    );\n    console.log(\"------------------------------------\");\n    throw new Error(\"Dummy error to make sure QRSMeteor stops running...\");\n    //removed auto install of sense, to prevent an issue with the rights...\n\n    // var executable = 'startSilentInstall.ps1';\n    // var installer = path.join(Meteor.settings.broker.automationBaseFolder, 'InstallationSoftware', executable);\n    // console.log('installer', installer)\n    // await new Promise(function(resolve, reject) {\n    //     try {\n    //         var spawn = require(\"child_process\").spawn,\n    //             child;\n    //         child = spawn(\"powershell.exe\", [installer]);\n    //         child.stdout.on(\"data\", function(data) {\n    //             console.log(\"Powershell Data: \" + data);\n    //         });\n    //         child.stderr.on(\"data\", function(data) {\n    //             console.error(\"Powershell Errors: \" + data);\n    //             return reject('Error in running the silent installation script of qlik sense...');\n    //         });\n    //         child.on(\"exit\", function() {\n    //             console.log(\"Powershell Script finished\");\n    //             return resolve(\"Powershell Script finished\");\n    //         });\n    //         child.stdin.end(); //end input.\n    //     } catch (error) {\n    //         console.error('error in calling the start of silent install of qlik sense, ', error);\n    //     }\n    // });\n};\n\n// let ps = new shell({\n//     executionPolicy: 'Bypass',\n//     noProfile: true\n// });\n// var folder = Meteor.settings.broker.qlikSense.sharedPersistanceFolder;\n// var name = Meteor.settings.broker.qlikSense.sharedPersistanceFolderName;\n\n// // ps.addCommand('Write-Host Creating a shared folder on: ' + folder);\n// ps.addCommand('New-Item \"C:\\\\test\" –type directory');\n// // ps.addCommand('New-SmbShare –Name ' + name + ' –Path ' + folder + ' –FullAccess Everyone  ')\n\n// ps.invoke()\n//     .then(output => {\n//         console.log(output);\n//     })\n//     .catch(err => {\n//         console.error('Installation of Qlik Sense failed, make sure you check the log file in GitHub\\QRSMeteor\\.automation\\InstallationSoftware\\log.txt', err)\n//         ps.dispose();\n//     });\n\n//\n// ─── REMOVE STREAMS AND APPS CREATED DURING THE SAAS DEMO ───────────────────────\n//\n\nfunction removeGeneratedResources() {\n    // console.log('remove the all generated resources on each server start');\n    // Meteor.setTimeout(function() {\n    //     console.log('remove all generated resources in mongo and qlik sense periodically by making use of a server side timer');\n    //     Meteor.call('removeGeneratedResources', {});\n    // }, 0); //remove all logs directly at startup\n    if (Meteor.settings.broker.automaticCleanUpGeneratedApps === \"Yes\") {\n        Meteor.setInterval(function() {\n            console.log(\n                \"remove all generated resources in mongo and qlik sense periodically by making use of a server side timer\"\n            );\n            Meteor.call(\"removeGeneratedResources\", {});\n        }, 1 * 86400000); //remove all logs/apps/streams every 1 day\n    }\n}\n\nfunction optimizeMongoDB() {\n    // console.log('## setting up mongo indexes on generationUserId in the generated resources, customers and other collections, to increase mongo performance');\n    TemplateApps._ensureIndex({\n        generationUserId: 1,\n        id: 1\n    });\n    GeneratedResources._ensureIndex({\n        generationUserId: 1,\n        id: 1\n    });\n    Apps._ensureIndex({\n        id: 1\n    });\n    Customers._ensureIndex({\n        generationUserId: 1\n    });\n    Streams._ensureIndex({\n        id: 1\n    });\n    APILogs._ensureIndex({\n        createdBy: 1\n    });\n    APILogs._ensureIndex({\n        createDate: 1\n    });\n}\n\n//\n// ─── GET AN UPDATE WHEN QLIK SENSE HAS CHANGED ──────────────────────────────────\n//\n\n// function createNotificationListeners() {\n//     //Create notification listener in Qlik sense https://help.qlik.com/en-US/sense-developer/3.1/Subsystems/RepositoryServiceAPI/Content/RepositoryServiceAPI/RepositoryServiceAPI-Notification-Remove-Change-Subscription.htm\n//     //console.log('********* On meteor startup, Meteor tool registers itself at Qlik Sense to get notifications from Sense on changes to apps and streams.');\n//     //console.log('********* we try to register a notification on this URL: HTTP post to http://' + senseConfig.SenseServerInternalLanIP + ':' + senseConfig.port + '/' + senseConfig.virtualProxy + '/qrs/notification?name=app');\n//     //console.log('********* The notification URL for Streams is: ' + Meteor.settings.private.notificationURL + '/streams');\n\n//     try {\n//         const resultApp = HTTP.post('http://' + senseConfig.SenseServerInternalLanIP + ':' + senseConfig.port + '/' + senseConfig.virtualProxy + '/qrs/notification?name=app', {\n//             headers: authHeaders,\n//             params: { 'xrfkey': senseConfig.xrfkey },\n//             data: Meteor.settings.private.notificationURL + '/apps'\n//         })\n\n//         const resultStream = HTTP.post('http://' + senseConfig.SenseServerInternalLanIP + ':' + senseConfig.port + '/' + senseConfig.virtualProxy + '/qrs/notification?name=stream', {\n//                 headers: authHeaders,\n//                 params: { 'xrfkey': senseConfig.xrfkey },\n//                 data: Meteor.settings.private.notificationURL + '/streams'\n//             })\n//             //console.log('Register notication success');\n//             // //console.log('the result from sense register App notification was: ', resultApp);\n//             // //console.log('the result from sense register Stream notification was: ', resultStream);\n//     } catch (err) {\n//         console.error('Create notification subscription in sense qrs failed', err);\n//         // throw new Meteor.Error('Create notification subscription in sense qrs failed', err);\n//     }\n// }"]},"sourceType":"script","hash":"27621bc7fb213658ee24d5836d06ad77164755e7"}
